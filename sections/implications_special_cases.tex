\section{Notable implications}
\label{sec:implications-special-case}

\subsection{PLD and $f$-DP filters are NOT free in general}

\Cref{thm:universal_free_natural_filter,thm:well_ordering} give a necessary and sufficient condition for free PLD filters.
We now switch our view to $f$-DP using \Cref{prop:f-hs-equivalence,prop:sup-conv}, for which free filters correspond to
\Cref{alg:fdp_natural_filter} in Appendix, to illustrate these results and their implications.
The condition in \Cref{thm:universal_free_natural_filter}, which is necessary and sufficient for free privacy filters, translates as:
\begin{equation}\label{eq:thm-free-filter-fdp}
    \forall f \in \cF, \ \text{and} \ \cF' \subseteq \cF^\infty, f \otimes \conv(\cF') = \conv(f \otimes \cF'), 
\end{equation}
where $\otimes$ is $f$-DP composition, $f \otimes \cF' = \{f \otimes f': f' \in \cF' \}$, and $\conv$ is the lower convex envelope of a set of tradeoff curves.

All examples also apply to PLD by \Cref{prop:f-hs-equivalence}, but we visualize them using trade-off curves.
%
For examples and visualizations, we work with piece-wise linear tradeoff curves, which can be composed exactly using the following result.

\begin{proposition}[Exact composition of piecewise-linear tradeoff curves]
\label{prop:piecewise-linear-composition}
    Consider two piecewise-linear tradeoff curves $f_1, f_2$. 
    Denote $\alpha_{i, n_i} \in [0,1]$ the lengths of intervals over which $f_i$ is linear, 
    and $f'_{i,n_i} \leq 0$ the slope of $f_i$ on those intervals. 
    Denote $\delta_i \triangleq 1-f_i(0)$.
    
    That is, $\sum_{j=1}^{n_i} \alpha_{i, j} = 1$, and, noting $m_i(\alpha) = \arg\max_{n: \in \{1, n_i\}} \sum_{j=1}^{n} \alpha_{i,j} \leq \alpha$, we have:
    \[
        f_i(\alpha) = 1 - \delta_i + \sum_{j=1}^{m_i(\alpha)} f'_{i,j} \alpha_{i,j} + 
            \big(\alpha - \sum_{j=1}^{m_i(\alpha)} \alpha_{i,j} \big) f'_{i, j+1}.
    \]

    Let $k \in [1, n_1 n_2]$ index all combinations of $(j_{1, k}, j_{2,k}) \in [1, n_1] \times[1, n_2]$ 
    in order of increasing values of $-f'_{1,j_{1,k}}f'_{2,j_{2,k}}$. 
    That is, $k$ indexes all products of a slope from $f_1$ and a slope for $f_2$ 
    (which are now positive) sorted in decreasing order of magnitude. 
    With ne minus sign, the first index is thus the steepest negative slope.
    
    Then the composition $f \triangleq f_1 \otimes f_2$ is also a piecewise linear tradeoff curve, 
    with $\delta = \delta_1 + \delta_2 - \delta_1\delta_2$, and $\alpha_k = \alpha_{1,k}\alpha_{2,k}$ 
    and slopes $f'_k = -f'_{1,j_{1,k}}f'_{2,j_{2,k}}$. 
    That is, denoting $m(\alpha) = \arg\max_{k: \in \{1, n_1n_2\}} \sum_{k=1}^{n} \alpha_k \leq \alpha$, 
    $f = f_1 \otimes f_2$ is such that:
    \[
        f(\alpha) = 1 -\delta_1 - \delta_2 + \delta_1\delta_2 + 
            \sum_{j=1}^{m(\alpha)} f'_k \alpha_k + 
            \big(\alpha - \sum_{j=1}^{m(\alpha)} \alpha_k \big) f'_{k+1}.
    \]
\end{proposition}
\begin{proof}
    See \Cref{sec:proof-piecewise-linear}.
\end{proof}

A first implication \Cref{thm:universal_free_natural_filter,thm:well_ordering} is that there are no free $f$-DP filters in general:
\begin{corollary}[$f$-DP filters are NOT free]\label{corollary:no-free-filters}
    Consider $\cT$ the family of all tradeoff curves, and $\cF = \{f_{\epsilon, \delta}, \ \epsilon \geq 0, \ \delta \in [0,1] \}$ the set of tradeoff curves for all $(\epsilon, \delta)$-DP mechanisms.

    Neither $\cT$ nor $\cF$ have free $f$-DP filters. Precisely, \Cref{alg:fdp_natural_filter} is not $f$-DP.
\end{corollary}
\begin{proof}
    $\cF \subset \cT$, and $\cF$ has crossing tradeoff functions, which are thus not well ordered. By \Cref{thm:well_ordering}, \Cref{alg:natural_filter} is not PLD for budget $B$, and so by \Cref{prop:f-hs-equivalence,prop:sup-conv} \Cref{alg:natural_filter} is not $f$-DP.
\end{proof}

\Cref{fig:counter-example} directly illustrates a counter-example to \Cref{thm:universal_free_natural_filter}  (\Cref{eq:thm-free-filter-fdp}) visually. We show that there exists tradeoff curves in $\cF$ (approximate DP mechanisms) such that $\alpha \ \textrm{s.t.} \ g_1 \otimes \conv(g_1, g_2)(\alpha) < \conv(g_1 \otimes g_1, g_1 \otimes g_2)(\alpha)$. That is, the exists $f=g1$ and $\cH = \{g_1, g_2\}$ such that $f \otimes \conv(\cH) \neq \conv(f \otimes \cH)$, violating (\Cref{eq:thm-free-filter-fdp}). By \Cref{prop:f-hs-equivalence,prop:sup-conv}, there exists $L$ and $\cL'$ such that $L \oplus \sup{\cL'} \neq \sup\{L \oplus L' : L' \in \cL'\}$, violating \Cref{thm:universal_free_natural_filter}.
%
In fact, \Cref{fig:counter-example} illustrates the two cases to account for, to directly prove a special case of \Cref{thm:well_ordering} for $(\epsilon, \delta)$-DP:

\begin{proposition}[$(\epsilon, \delta)$-DP curves that cross always violate \Cref{thm:universal_free_natural_filter} (\Cref{eq:thm-free-filter-fdp})]\label{prop:no-commutativity-for-eps-delta}
    Consider $f \in \cT$, and any set of tradeoff curves $\cF$ such that $f_{\epsilon_1, \delta_1}$ and $f_{\epsilon_2, \delta_2}$ cross, and $f_{\epsilon_1, \delta_1}, f_{\epsilon_2, \delta_2} \in \cF$.
    
    $\cF$ does not have free $f$-DP filters. Precisely, \Cref{alg:fdp_natural_filter} is not $f$-DP.
\end{proposition}
\begin{proof}
    Direct corollary of \Cref{thm:well_ordering}, self standing direct proof in \Cref{sec:appendix:well-ordered-eps-delt}.
\end{proof}



% \begin{figure}[htbp]
%     \centering
%     \includegraphics[width=0.7\textwidth]{plots/counter-example.png}
%     \caption{Counter example to $\cref{eq:conv-commutativity}$, and hence free $f$-DP filters in general, for the family of all tradeoff curves, or arbitrary families of tradeoff curves $\cF$. {\color{blue}(Bingshan: here, you mean, hence, NO free $f$-DP filters in general? You missed a ``NO '' in the above  sentence?)}}
%     \label{fig:counter-example}
%     % Plots here: https://colab.research.google.com/drive/15fvCEe53jpBkm-hCB9fbfd-jJX9zP2KM?usp=sharing
% \end{figure}


% \begin{figure}[htbp]
%     \centering
%     \includegraphics[width=0.7\textwidth]{plots/composed-curves-dont-cross.png}
%     \caption{Counter example to $\cref{eq:conv-commutativity}$, for approx DP curves, even when the composed curves don't cross.}
%     \label{fig:counter-example-no-crossing}
%     % Plots here: https://colab.research.google.com/drive/15fvCEe53jpBkm-hCB9fbfd-jJX9zP2KM?usp=sharing
% \end{figure}

\begin{figure}[htbp]
  \centering
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics[width=\linewidth]{plots/counter-example.png}
    \caption{Case 1: $g_1 \otimes g_1$ and $g_1 \otimes g_2$ cross.}
    \label{subfig:counter-example-crossing}
  \end{subfigure}\hfill
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics[width=\linewidth]{plots/composed-curves-dont-cross.png}
    \caption{Case 2: $g_1 \otimes g_1 \geq g_1 \otimes g_2$}
    \label{subfig:counter-example-not-crossing}
  \end{subfigure}
  \caption{Counter examples to $\Cref{thm:universal_free_natural_filter}$ (\Cref{eq:thm-free-filter-fdp}), showing that $f$-DP filters are NOT free in general (for the set of all tradeoff curves $\cT$), or when choosing adaptively among the set of $(\epsilon, \delta)$-DP mechanisms. This is true even if $f\in\cF$.}
  \label{fig:counter-example}
  % Plots here: https://colab.research.google.com/drive/15fvCEe53jpBkm-hCB9fbfd-jJX9zP2KM?usp=sharing
\end{figure}

Another interesting case is that of pure DP, or $\epsilon$-DP, mechanisms. Indeed, this family is well ordered ($\epsilon_1 > \epsilon_2 \geq 0 \Rightarrow f_{\epsilon_1} \preceq f_{\epsilon_2}$, illustrated on \Cref{subfig:pure-dp-twosteps}), and known to admit privacy filters under basic composition \citep{RRUV16}. However, this family of DP mechanisms is not closed under $f$-DP or PLD composition, and its self composition is not well ordered anymore, as illustrated on \Cref{subfig:pure-dp-counter-example}. As we can see, this is sufficient to violate \Cref{thm:universal_free_natural_filter,thm:well_ordering}, and hence rule out free $f$-DP/PLD filters for the family of $\epsilon$-DP under $f$-DP/PLD composition.

\begin{figure}[htbp]
  \centering
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics[width=\linewidth]{plots/pure-dp-twosteps.png}
    \caption{$\epsilon$-DP admits two-step filters (example)}
    \label{subfig:pure-dp-twosteps}
  \end{subfigure}\hfill
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics[width=\linewidth]{plots/pure-dp-no-filter.png}
    \caption{$\epsilon$-DP general filter counter-example}
    \label{subfig:pure-dp-counter-example}
  \end{subfigure}
  \caption{$\epsilon$-DP mechanisms are well ordered, but not closed under composition.
  If $\cF = \{ f_\epsilon: \ \epsilon \geq 0 \}$, then $\cF^2 \subset \cF^\infty$ is not well ordered (\Cref{subfig:pure-dp-twosteps}), and by \Cref{thm:well_ordering} pure DP mechanisms do not admit an $f$-DP/PLD filter (\Cref{subfig:pure-dp-counter-example}).}
  \label{fig:counter-example-pure-dp}
  % Plots here: https://colab.research.google.com/drive/15fvCEe53jpBkm-hCB9fbfd-jJX9zP2KM?usp=sharing
\end{figure}





We have shown that $f$-DP/PLD filters are not free in general (when $\cF$ is the set of all tradeoff curves), or for the set of $(\epsilon, \delta)$-DP mechanisms.
%
These results are surprising, as all previous filter results were that filters are free (RDP/zCDP \cite{feldman2021individual,lecuyer2021practical}, GDP \cite{koskelaindividual,smith2022fullyadaptivecompositiongaussian}) or asymptotically free ($(\epsilon,\delta)$-DP \cite{rogers2016privacy, whitehouse2023fully}).
% We show that filters for $f$-DP and $(\epsilon, \delta)$-DP are not completely free, though characterizing the gap (e.g., are known results tight) is still an open question.
%
One might hope that restricting $f$, the bound on privacy loss used as input to the $f$-DP filter, would be sufficient to ensure free filters. Two natural candidates come to mind. First, restricting $f \in \cF$, a practical condition of choosing privacy bounds in the set of tradeoff curves used in the filter. Second, we could restrict $f$ to a GDP curve $G_\mu$ (the tradeoff curve of a Gaussian mechanism), or an approximate GDP curve $f_{0, \delta} \otimes G_\mu$ to support approximate DP $f_{\epsilon, \delta}$ tradeoff curves in $\cF$. These are good candidates, as $\{G_\mu : \mu \in \bR^+\}$ is the only known set of tradeoff curves to have free $f$-DP filters \cite{koskelaindividual,smith2022fullyadaptivecompositiongaussian}.

Unfortunately, neither restriction is sufficient:

\begin{corollary}\label{cor:no-free-filter-for-f-in-F}
    Consider the set of $(\epsilon, \delta)$-DP tradeoff curves $\cF = \{f_{\epsilon, \delta} : \epsilon \geq 0, \ \delta \in [0,1]\}$. $\cF$ does not have free $f$-DP filters even for $f \in \cF$.
\end{corollary}
\begin{proof}
    Consider two tradeoff curves that cross $g_1 = f_{\epsilon_1, \delta_1} \in \cF$ and $g_2 = f_{\epsilon_2, \delta_2} \cF$, that fall in \emph{case 1} in the proof of \Cref{prop:no-commutativity-for-eps-delta} (this is possible, but the proof is identical for \emph{case 2}, swapping the proper slope).

    Pick $f = f_{\epsilon, \delta}$ with $\epsilon = \log\big(e^{2\epsilon_1} - (1+e^{\epsilon_1})\frac{\delta_2 - \delta_1}{\alpha_1^{\star}}\big)$ (that is, $e^{-\epsilon}$ is the first slope of $\conv(g_1 \otimes g_1, g_1 \otimes g_2)$) and $\delta = \delta_1+\delta_2 - \delta_1\delta_2$ (that is, the $\delta$ of $\conv(g_1 \otimes g_1, g_1 \otimes g_2)$).

    Consider an adversary playing \Cref{alg:fdp_natural_filter} with a $g_1$ mechanism first, and then an adaptive choice between $g_1, g_2$. By construction, $\conv(g_1 \otimes g_1, g_1 \otimes g_2) \geq f$, so $g_1 \otimes g_1 \geq f$ and $g_1 \otimes g_2 \geq f$: \Cref{alg:fdp_natural_filter} always accepts the query.
    
    From the proof of \Cref{thm:universal_free_natural_filter} we know that a two-steps filter can play $g_1 \otimes \conv(g_1, g_2)$.
    By construction, we have that $f(\alpha) = \conv(g_1 \otimes g_1, g_1 \otimes g_2)(\alpha)$ on $\alpha \in (0, \alpha_1^{\star2}]$ 
    From \Cref{subfig:counter-example-crossing} (and the proof of \Cref{prop:no-commutativity-for-eps-delta}) we know that on $\alpha \in (0, \alpha_1^{\star2}]$, we have $g_1 \otimes \conv(g_1, g_2)(\alpha) < \conv(g_1 \otimes g_1, g_1 \otimes g_2)(\alpha) = f(\alpha)$. \Cref{alg:fdp_natural_filter} is thus not $f$-DP, concluding the proof.
\end{proof}


\begin{figure}[htbp]
  \centering
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics[width=\linewidth]{plots/GDP-f-counter-example.png}
    \caption{GDP $G_\mu$ filter bound}
    \label{subfig:counter-example-pure-gdp}
  \end{subfigure}\hfill
  \begin{subfigure}[t]{0.48\textwidth}
    \centering
    \includegraphics[width=\linewidth]{plots/approxGDP-f-counter-example.png}
    \caption{Approximate GDP $f_{0, \delta} \otimes G_\mu$ filter bound}
    \label{subfig:counter-example-approx-gdp}
  \end{subfigure}
  \caption{Counter example to free $f$-DP filters when \(f\) is GDP (a) or approximate\ GDP (b).}
  \label{fig:counter-example-GDP}
  % Plots here: https://colab.research.google.com/drive/15fvCEe53jpBkm-hCB9fbfd-jJX9zP2KM?usp=sharing
\end{figure}


\begin{corollary}\label{cor:no-free-filter-for-f-gaussian}
    The set of all tradeoff curves $\cT$ does not have free $f$-DP filters even for $f \in \{ G_\mu : \mu \geq 0 \}$.
    
    The set of $(\epsilon, \delta)$-DP tradeoff curves $\cF = \{f_{\epsilon, \delta} : \epsilon \geq 0, \ \delta \in [0,1]\}$ does not have free $f$-DP filters even for $f \in \{ f_{0, \delta} \otimes G_\mu : \mu \geq 0, \delta \in [0, 1] \}$.
\end{corollary}
\begin{proof}
    Following the reasoning of \Cref{cor:no-free-filter-for-f-in-F}, we show that we can construct a set of two tradeoff curves $g_1, g_2 \in \cF$, and a bound $f$ in the correct family, such that $\conv(g_1 \otimes g_1, g_1 \otimes g_2) \geq f$ but there exists values of $\alpha$ s.t. $g_1 \otimes \conv(g_1, g_2)(\alpha) < f$. \Cref{subfig:counter-example-pure-gdp} shows such a construction for $f \in \{ G_\mu : \mu \geq 0 \}$ and \Cref{subfig:counter-example-approx-gdp} for $f \in \{ f_{0, \delta} \otimes G_\mu : \mu \geq 0, \delta \in [0, 1] \}$.
    All trade-off curves are (compositions of) piecewise linear functions, or Gaussian trade-offs. They can thus be computed exactly in closed-form.
\end{proof}


\subsection{Families of mechanisms with free filters}

\Cref{thm:well_ordering}, combined with \Cref{prop:f-hs-equivalence}, show that a family of DP mechanisms that is closed under composition, and with well ordered tradeoff curves, admits free $f$-DP (and PLD by \Cref{prop:f-hs-equivalence}) filters.

\begin{corollary}\label{cor:gaussian-filter}
    The set of all Gaussian tradeoff curves $G =  \{ G_\mu : \mu \geq 0 \}$ has free filters. That is \Cref{alg:fdp_natural_filter} is $f$-DP.
\end{corollary}
\begin{proof}
    For any $\mu_1, \mu_2 \geq 0$, $G_{\mu_1} \otimes G_{\mu_2} = G_{\sqrt{\mu_1^2 + \mu_2^2}} \in G$.
    If $\mu_1 > \mu_2$, then $G_{\mu_1} \preceq G_{\mu_2}$.
    Gaussian mechanisms are closed under composition and well ordered: by \Cref{thm:well_ordering}, they have free $f$-DP/PLD filters, as already shown in \cite{koskelaindividual,smith2022fullyadaptivecompositiongaussian}.
\end{proof}

\begin{corollary}\label{cor:pure-delta-filter}
    The set of all $0, \delta$-DP tradeoff curves $\cH =  \{ f_{0, \delta} : \delta \in [0, 1] \}$ has free filters. That is \Cref{alg:fdp_natural_filter} if $f$-DP.
\end{corollary}
\begin{proof}
    For any $\delta_1, \delta_2 \geq 0$, $f_{0,\delta_1} \otimes f_{0,\delta_2} = f_{0,\delta_1 + \delta_2 - \delta_1\delta_2} \in \cH$.
    If $\delta_1 > \delta_2$, then $f_{0,\delta_1} \preceq f_{0,\delta_2}$.
    Pure $\delta$ mechanisms are closed under composition and well ordered: by \Cref{thm:well_ordering}, they have free $f$-DP/PLD filters.
\end{proof}

% The family of subsampled Gaussian mechanisms with monotonously decreasing subsampling rates (that is, subsampling rate $p(\mu)$ is monotonously decreasing in $\mu$).
% As special cases, subsampled Gaussian mechanisms with fixed subsampling rate, and the subsampled Gaussian mechanisms with fixed $\mu$ (and arbitrary $p$) both have free $f$-DP filters.
% For instance, when running DP-SGD with $f$-DP accounting \ml{cite}, one can adaptively choose $\mu$ OR $p$ OR both according to a monotonously decreasing family within a lower-bound $f$, applying regular composition results or empirical computations of the tradeoff curve \ml{cite}.

% The family of subsampled Gaussian mechanisms with monotonously decreasing $\mu$ as a function of the subsampling rate (that is, $\mu(p)$ is monotonously decreasing in $p$). As a special case, a set of mechanisms that apply Gaussian noise with fixed variance, but have variable subsampling rate $p$, are 

% The family of $\big(\epsilon, \delta(\epsilon)\big)$-DP mechanisms where $\delta(\epsilon)$ is a monotonously increasing function of $\epsilon$ has free $f$-DP filters. In particular, the family $\epsilon$-DP mechanisms, and of $(\epsilon, \delta)$-DP mechanisms with fixed $\delta$, both have free $f$-DP filters. This is interesting, as it means that we can apply optimal (strong) composition in a privacy filter for $\epsilon$-DP (or any $(\epsilon, \delta)$-DP mechanisms with fixed $\delta$) (and hence run a privacy filter with empirical composition \ml{cite} or any other composition result), but not the family of all $(\epsilon, \delta)$-DP mechanisms.


